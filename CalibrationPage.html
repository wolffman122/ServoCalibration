<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <style>
      body {
        text-align: center;
        font-family: "Trebuchet MS", Arial;
        margin-left:auto;
        margin-right:auto;
        
      }
      table, th, td {
        border: 1px solid black;

      }
      .slider {
      -webkit-appearance: none;
      width: 300px;
      height: 25px;
      border-radius: 10px;  
      background: #ffffff;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 35px;
      height: 35px;
      border-radius: 50%; 
      background: #ff3410;
      cursor: pointer;
    }
      
    
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>
  <body style="background-color:#70cfff;">
    <table>
      <thead>
        <tr>
          <th>Servo #</th>
          <th>Minimum PWM</th>
          <th>Maximum PWM</th>
          <th>Position</th>
          <th>Adjustment</th>
        </tr>
      </thead>
      <tbody id="servoTableBody">

      </tbody>
    </table>
  </body>
  <script>
    var Socket;

    function init()
    {
      Socket = new WebSocket('ws://192.168.0.132:81');
      Socket.onmessage = function(event)
      {
        processCommand(event);
      }
    }

    function processCommand(event)
    {
      var obj = JSON.parse(event.data);
      if(obj["data"])
      {
        const servos = obj["data"];
        const tableBody = document.getElementById("servoTableBody");

        // Clear current rows
        tableBody.innerHTML = "";

        for(var i = 0; i < servos.length; i++)
        {
          let row = document.createElement("tr");
          let pos = servos[i].position ?? 5;
          row.innerHTML = `
            <td>Servo ${i+1}</td>
            <td>
              <input type="number" id="minimum${i}" value="${servos[i].minimum}"
              onchange="updateServoData(${i})">
            </td>
            <td>
              <input type="number" id="maximum${i}" value="${servos[i].maximum}"
              onchange="updateServoData(${i})">
            </td>
            <td><h2 style="color:#ffffff;">Position: <span id="servoPos${i}">${pos}</span>&#176;</h2></td>
            <td>
              <input type="range" min="0" max="180" value="${pos}" class="slider" id="servoSlider${i}" 
              onchange="servo(${i}, this.value)"/>
            </td>
          `;
      
          tableBody.appendChild(row);

          console.log(servos[i].position);
          console.log(servos[i].minimum);
          console.log(servos[i].maximum);
        }
      }
    }

    function servo(number, pos)
    {
      document.getElementById("servoPos" + number).innerHTML = pos;
      sendServoData();
    }

    function updateServoData(number)
    {
      sendServoData();
    }

    function sendServoData()
    {
      const tableBody = document.getElementById("servoTableBody");
      const rows = tableBody.getElementsByTagName("tr");
      const servoData = [];

      for(let i = 0; i < rows.length; i++)
      {
        let minValue = parseInt(document.getElementById("minimum" + i).value);
        let maxValue = parseInt(document.getElementById("maximum" + i).value);
        let positionValue = parseInt(document.getElementById("servoPos" + i).innerHTML);

        servoData.push({
          servoNumber: i,
          minimum: minValue,
          maximum: maxValue,
          position: positionValue
        });
      }

      console.log(JSON.stringify(servoData));
      Socket.send(JSON.stringify(servoData));
    }

    window.onload = function(event)
    {
      init();
    }
    
  </script>
</html>